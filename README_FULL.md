# Установка

Для работы скрипта в системе должен быть установлен 
- python (предустановлен в SberOS и всех вармах)
- javascript (поддерживается в SberBrowser)
- подключение к базе данных, DBeaver (доступно для дата инженера)

Скрипт не использует сторонних python библиотек и не подключается к интернету, доступна возможность работы в оффлайн.
Библиотека Javascript - mermaid.min.js поставляется оффлайн вместе с проектом (используется для отрисовки графиков зависимостей)

## Шаг 1.

Клонируйте или скачайте репозиторий проекта:

## Шаг 2. Подготовьте данные для анализа:

## Шаг 2.1 С помощью SQL Запросов

   Запустите dbeaver и подключите к базе данных Greenplum (pg).
   Запустите скрипт, собирающий данные по функциям __sql/getfuncs.sql__ (замените на свою схему)
```SQL
   SELECT
    n.nspname AS schema_name,
    p.proname AS function_name,
    pg_catalog.pg_get_function_result(p.oid) AS return_type,
    pg_catalog.pg_get_function_arguments(p.oid) AS arguments,
    pg_catalog.pg_get_functiondef(p.oid) AS function_definition
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'your_schema_name'
ORDER BY schema_name, function_name;
```
    
Нажмите правой кнопкой по таблице и выберите "Экспортировать как.." Выберите json  и снимите галочку заголовок.
    Положите сохраненный json в папку data/functions. Вы можете сохранить несколько json по разным схемам.

Проделайте то же самое с таблицами (sql/gettables.sql). Поддерживается несколько файлов json по разным схемам.
```SQL 
SELECT
    c.table_schema,
    c.table_name,
    array_agg(c.column_name::text) AS column_names,
    array_agg(c.data_type::text) AS data_types
FROM information_schema.columns c
WHERE c.table_schema = 'your_schema_name'
  AND c.table_name NOT IN (
      SELECT c.relname
      FROM pg_inherits i
      JOIN pg_class c ON i.inhrelid = c.oid
  )
GROUP BY c.table_schema, c.table_name;
```
    
## Шаг 2.2. Ручная подготовка данных

__Внимание: если вы выполнили предыдущий шаг, эти действия не требуются__

Скрипт принимает данные формата json в качестве входных данных.

Поместите json, содержащий описание функций в папку data/functions/
Пример структуры файла:
```json
[	
    {
		"schema_name" : "s_grnplm_vd_rozn_ss_stg",
		"function_name" : "simple_function",
		"return_type" : "boolean",
		"arguments" : "",
		"function_definition" : "CREATE OR REPLACE FUNCTION ..."
    }
]
```
Поместите json, содержащий описание таблиц в папку data/functions/
Пример структуры файла:
```json
[
	{
		"table_schema" : "s_grnplm_vd_rozn_ss_stg",
		"table_name" : "databasechangeloglock",
		"column_names" : "{lockgranted,lockedby,id,locked}",
		"data_types" : "{timestamp without time zone,character varying,integer,boolean}"
	}
]
```

## Шаг 3. Запуск скрипта
Откройте консоль в папке проекта.  Запустите скрипт:
```bash
python3 processing.py
```

## Шаг 4. Результат. Использование сканера.
Запустите файл index.html в любом браузере. 
Для этого, например, нажмите правой кнопкой на файле, затем открыть с помощью, SberBrowser.



# Использование сканера

Слева находится меню, где можно выбрать для просмотра функцию или таблицу. Ссылки сгруппированы по схемам и позволяют сворачивать и разворачивать ссылки.

### Информация по таблицам 

Меню слева содержат информацию по схемам и таблицам.  Текст ссылок на таблице выделен голубым цветом.
При нажатии на название таблицы, откроется окно, где будет показана структура таблицы, а также функции, которые используют ее явным образом в своем ddl.
Ссылки на функции интерактивные и ведут на страничку функций.

Таким образом аналитик может отследить использование таблиц в разных функциях.

### Информация по функциям

Меню слева содержат информацию по схемам и функциям.  Текст ссылок на таблицы выделен голубым цветом.

Просмотр функции содержит два режима - текстовый и визуальный. 
Текстовый выделяет цветом ключевые слова, связанные с использованием таблиц, сами таблицы и функции.
Функции и таблицы интерактивные и ведут на свои страницы.

При наведении мышки на название таблицы, появляется подсказка с описанием таблицы. 
Для того чтобы можно было просматривать таблицы с большим количеством атрибутов, всплывающая таблица скрывается только после нажатия левой кнопки мыши у другом месте

По нажатию левой кнопки можно перейти на страницу таблицы.

Кнопка справа сверху меняет режим отображения на визуальный. 
Граф состоит из элементов двух типов: круглые показывают функции, квадратные - таблицы. Стрелочка от фукнции означает, что в этой функции используются таблицы или функции с этим названием.
Постройка графа работает рекурсивно. Это значит, что для каждой следующей функцией строятся связи, идущей от нее и так до последней.



