|schema_name|function_name             |return_type|arguments                                                                   |function_definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|-----------|--------------------------|-----------|----------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|public     |add_missed_date_partitions|boolean    |table_src text, table_dst text                                              |CREATE OR REPLACE FUNCTION public.add_missed_date_partitions(table_src text, table_dst text)¶ RETURNS boolean¶ LANGUAGE plpgsql¶AS $function$¶declare¶    date_src_start DATE;¶    date_src_end DATE;¶    date_dst_start DATE;¶    date_dst_end DATE;¶    date_interval INTERVAL;¶    partition_column TEXT;¶--     partition_column_datatype TEXT;¶begin¶    partition_column := 'date';¶    -- test date¶    date_dst_start := DATE '2024-01-01';¶    date_dst_end := DATE '2024-12-01';¶    -- test interval¶    date_interval := INTERVAL '1 month';¶    execute format('select max(%I) from %I', partition_column, table_src) into date_src_end;¶        raise notice 'data src max %: %', table_src, date_src_end;¶    execute format('select min(%I) from %I', partition_column, table_src) into date_src_start;¶        raise notice 'data src min %: %', table_src, date_src_start;¶    return True;¶end;¶$function$¶                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|public     |create_monthly_partitions |void       |source_schema text, source_table text, target_schema text, target_table text|CREATE OR REPLACE FUNCTION public.create_monthly_partitions(source_schema text, source_table text, target_schema text, target_table text)¶ RETURNS void¶ LANGUAGE plpgsql¶AS $function$¶DECLARE¶    start_date DATE;¶    end_date DATE;¶    partition_start DATE;¶    partition_end DATE;¶    partition_name TEXT;¶BEGIN¶    -- Динамически формируем запрос для получения минимальной и максимальной даты из таблицы-источника¶    EXECUTE format('SELECT MIN(date), MAX(date) FROM %I.%I', source_schema, source_table)¶    INTO start_date, end_date;¶¶    -- Проверяем, что в таблице-источнике есть данные¶    IF start_date IS NULL OR end_date IS NULL THEN¶        RAISE NOTICE 'Таблица %I.%I пуста. Партиции не созданы.', source_schema, source_table;¶        RETURN;¶    END IF;¶¶    -- Устанавливаем начальную дату для партиций¶    partition_start := date_trunc('month', start_date);¶¶    -- Запускаем цикл, чтобы создать партиции по месяцам до end_date¶    WHILE partition_start <= end_date LOOP¶        partition_end := partition_start + INTERVAL '1 month' - INTERVAL '1 day';¶        partition_name := format('%I_%s', target_table, to_char(partition_start, 'YYYY_MM'));¶¶        -- Создаём партицию для каждого месяца в целевой таблице¶        EXECUTE format('¶            CREATE TABLE IF NOT EXISTS %I.%I PARTITION OF %I.%I¶            FOR VALUES FROM (%L) TO (%L)',¶            target_schema, partition_name,¶            target_schema, target_table,¶            partition_start,¶            partition_end + INTERVAL '1 day'¶        );¶¶        -- Переходим к следующему месяцу¶        partition_start := partition_start + INTERVAL '1 month';¶    END LOOP;¶¶    RAISE NOTICE 'Партиции для таблицы %I.%I успешно созданы от % до %', target_schema, target_table, start_date, end_date;¶END;¶$function$¶|
